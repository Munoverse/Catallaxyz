# Catallaxyz 项目完整介绍

**版本:** v1.1.0  
**最后更新:** 2026年1月31日

---

## 目录

1. [项目简介](#项目简介)
2. [核心概念](#核心概念)
3. [技术架构](#技术架构)
4. [功能详解](#功能详解)
5. [市场生命周期](#市场生命周期)
6. [用户指南](#用户指南)
7. [管理员指南](#管理员指南)
8. [费用结构](#费用结构)
9. [安全机制](#安全机制)

---

## 项目简介

### 什么是 Catallaxyz?

Catallaxyz 是一个基于 Solana 区块链的自结算预测市场协议。与传统预测市场不同，Catallaxyz 实现了无需外部结果验证的市场机制，适用于高度主观、无法客观验证的预测场景。

### 理论基础

项目基于哈佛团队论文 **"Self-Resolving Prediction Markets for Unverifiable Outcomes"** (https://arxiv.org/abs/2306.04305)，核心创新包括:

1. **随机终止机制**: 使用 Switchboard VRF 实现基于负交叉熵的市场终止
2. **概率结算**: 不同于赢家通吃，最终按概率分配，输家也能获得部分回报
3. **信息激励**: 用户通过交易差价获得信息增量奖励

### 核心创新

1. **随机终止 (VRF)**
   - 每笔买入交易有 0.1% 概率触发市场终止
   - 最终价格基于终止时的最后交易价格
   - 防止输家资金完全归零

2. **Meme币打赏排名**
   - 市场排名由打赏金额决定
   - 支持对评论和市场创建者的打赏
   - 打赏使用指定的Meme币

3. **免Gas交易**
   - 链下撮合，链上验证
   - 平台承担Gas费用
   - 用户完全免费交易

---

## 核心概念

### 二元市场 (Binary Market)

每个市场只有两个结果: YES 和 NO

- **YES Token**: 代表对市场问题的肯定预测
- **NO Token**: 代表对市场问题的否定预测
- **价格**: 0.01 - 0.99 USDC (代表概率 1% - 99%)
- **恒等式**: YES价格 + NO价格 = 1 USDC

### 仓位 (Position)

用户持有的YES/NO代币数量

| 操作 | 描述 | 费用 |
|------|------|------|
| 拆分 (Split) | 1 USDC → 1 YES + 1 NO | 无 |
| 合并 (Merge) | 1 YES + 1 NO → 1 USDC | 无 |
| 赎回 (Redeem) | 市场结束后按最终价格兑换 | 无 |

### 订单类型

| 类型 | 描述 | 手续费 |
|------|------|--------|
| 限价单 (Limit) | 指定价格挂单，等待成交 | 0% + 返佣 |
| 市价单 (Market) | 立即以最优价格成交 | 0.2% - 3.2% |

---

## 技术架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            用户界面 (Frontend)                           │
│                    Next.js + React + TailwindCSS                        │
│                       Phantom SDK (钱包集成)                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
┌───────────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐
│   Data API (3001)     │ │ CLOB API (3002) │ │   WebSocket (3003)      │
│   市场/用户数据查询    │ │ 订单撮合引擎    │ │   实时数据推送           │
│   钱包签名验证         │ │ L1/L2认证       │ │                         │
└───────────────────────┘ └─────────────────┘ └─────────────────────────┘
            │                     │                       │
            └──────────┬──────────┴───────────────────────┘
                       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         后端服务 (Backend)                               │
│                      Fastify + TypeScript                               │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐  ┌───────────────┐ │
│  │  L1/L2认证  │  │  Redis撮合   │  │  Exchange   │  │  Keeper任务   │ │
│  │  钱包签名   │  │  Lua脚本     │  │  结算执行器  │  │              │ │
│  └─────────────┘  └──────────────┘  └─────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
            │                     │                       │
    ┌───────┴───────┐     ┌───────┴───────┐      ┌───────┴───────┐
    ▼               ▼     ▼               ▼      ▼               ▼
┌─────────┐   ┌─────────┐ ┌─────────────────┐ ┌─────────────────────────┐
│Supabase │   │ Redis   │ │ Solana Devnet/  │ │    Switchboard VRF      │
│(数据库)  │   │(CLOB)   │ │ Mainnet         │ │    (随机数生成)          │
└─────────┘   └─────────┘ └─────────────────┘ └─────────────────────────┘
```

### 技术栈

| 层级 | 技术 |
|------|------|
| 前端 | Next.js 14, React 18, TailwindCSS |
| 后端 | Fastify, TypeScript, Node.js 18+ |
| 数据库 | Supabase (PostgreSQL) |
| 缓存/CLOB | Redis + Lua 脚本 |
| 区块链 | Solana, Anchor 0.32.1 |
| 钱包 | Phantom SDK (@phantom/react-sdk) |
| 随机数 | Switchboard VRF |
| 部署 | Vercel (前端), AWS EC2 (后端) |

### 目录结构

```
Catallaxyz/
├── apps/
│   ├── backend/           # 主后端服务
│   │   ├── src/
│   │   │   ├── routes/    # API路由
│   │   │   ├── lib/       # 核心库
│   │   │   ├── workers/   # 后台任务
│   │   │   └── ws-server/ # WebSocket服务
│   │   └── package.json
│   └── frontend/          # 主前端应用
│       └── src/
│           ├── app/       # Next.js App Router
│           ├── components/# React组件
│           └── lib/       # 工具库
├── contracts/
│   └── catallaxyz/
│       ├── programs/      # Solana智能合约
│       │   └── catallaxyz/
│       │       └── src/
│       ├── scripts/       # 部署和管理脚本
│       ├── shared/        # 共享类型和工具
│       └── migrations/    # 数据库迁移
└── docs/                  # 文档
```

---

## 功能详解

### 2.1 市场创建

**用户功能:**
- 任何用户可创建多个预测市场
- 需支付 10 USDC 创建费用
- 设置市场标题、描述、结束时间
- 选择市场分类

**创建流程:**
1. 连接钱包
2. 填写市场信息
3. 支付创建费用
4. 等待链上确认
5. 市场激活

**代码位置:** `programs/catallaxyz/src/instructions/create_market.rs`

### 2.2 随机终止机制

**触发条件:**
- 买入交易成功后自动触发
- 默认 0.1% 概率终止 (可由管理员调整)
- 使用 Switchboard VRF 生成随机数

**终止流程:**
1. 用户完成买入交易
2. 系统调用 Switchboard VRF
3. 获取随机数
4. 判断是否触发终止
5. 如触发，记录最终价格并终止市场

**管理员控制:**
```typescript
// 更新终止概率 (需要同步到链上和数据库)
await program.methods.updateMarketParams({
  terminationProbability: newProbability  // 0.001 = 0.1%
}).accounts({...}).rpc();
```

### 2.3 限价单做市商奖励

**奖励机制:**
- 限价单无手续费
- 做市商提供流动性获得积分
- 积分基于:
  - 挂单时长
  - 挂单金额
  - 距离中间价的距离

**奖励计算:**
```
每日积分 = Σ (挂单金额 × 挂单时长 × 距离权重)
奖励 = (用户积分 / 总积分) × 日奖励池
```

**发放流程:**
1. 每日UTC 0:00结算
2. 链下计算积分权重
3. 生成发放列表
4. 链上批量发放

### 2.4 动态手续费

**费率曲线:**
```
费率 = 中心费率 - (中心费率 - 极端费率) × |价格 - 0.5| / 0.5
```

| 价格 | 费率 |
|------|------|
| 0.50 (50%) | 3.2% (最高) |
| 0.40 / 0.60 | 2.6% |
| 0.30 / 0.70 | 2.0% |
| 0.20 / 0.80 | 1.4% |
| 0.10 / 0.90 | 0.8% |
| 0.01 / 0.99 | 0.2% (最低) |

**设计理念:** 越接近50%的价格，不确定性越高，收取更高费用

### 2.5 手续费分配

| 接收方 | 比例 | 用途 |
|--------|------|------|
| 平台金库 | 75% | 平台运营 |
| 做市商奖励 | 20% | 每日流动性奖励 |
| 市场创建者 | 5% | 创建者激励 |

**代码位置:** `programs/catallaxyz/src/instructions/settle_trade.rs`

### 2.6 通知功能

**通知类型:**
- `trade_filled`: 订单成交
- `market_settled`: 参与的市场结算
- `market_terminated`: 创建/参与的市场终止

**实现:**
- WebSocket 实时推送
- 数据库持久化
- 未读计数标记

### 2.7 用户管理

**个人仪表盘:**
- 钱包地址显示
- 个人简介编辑
- 交易记录
- 参与的市场
- 创建的市场
- 收藏的市场
- 盈亏统计

### 2.8 登录管理

**Phantom SDK 集成:**
- 使用 `@phantom/react-sdk` 进行钱包连接
- 支持 Phantom 钱包（浏览器扩展和移动端）
- 支持多链地址（Solana, Ethereum 等）

**核心 Hooks:**
- `usePhantom`: 连接状态和地址管理
- `useSolana`: Solana 特定操作（签名、发送交易）
- `useDisconnect`: 断开钱包连接

**认证流程:**
1. 用户点击"连接钱包"
2. Phantom SDK 弹出连接请求
3. 用户授权后获取钱包地址
4. 后端验证钱包签名
5. 创建或获取用户记录

**强制用户名:**
- 首次登录必须设置@用户名
- 用户名唯一
- 用于通知和社交功能

### 2.9 链下撮合机制 (CLOB)

**L1/L2 认证系统:**

| 层级 | 用途 | 签名方式 |
|------|------|----------|
| L1 | 创建 API Key | Ed25519 钱包签名 |
| L2 | API 请求认证 | HMAC-SHA256 |

**L1 认证 (首次):**
```
1. 用户签名消息: "Catallaxyz CLOB auth:{wallet}:{timestamp}:{nonce}"
2. 后端验证 Ed25519 签名
3. 生成 API Key + Secret + Passphrase
4. 返回凭证给前端存储
```

**L2 认证 (每次请求):**
```
1. 构建签名载荷: {timestamp}{METHOD}{path}{body}
2. 使用 API Secret 计算 HMAC-SHA256
3. 发送请求头:
   - poly_api_key: API Key
   - poly_passphrase: Passphrase
   - poly_signature: HMAC 签名
   - poly_timestamp: 时间戳
   - poly_address: 钱包地址
```

**撮合流程:**
```
1. 用户提交订单 → CLOB API (L2认证)
2. Redis Lua 脚本 → 原子撮合
3. 生成成交记录 → PostgreSQL 持久化
4. Exchange 执行器 → 链上结算 (match_orders)
5. 合约验证执行 → 更新状态
```

**优势:**
- 用户免Gas费
- 高吞吐量 (Redis Lua 原子操作)
- 低延迟
- Polymarket 风格 API 兼容

### 2.10 Gas费用处理

**拆分/合并/赎回:**
- 使用 Kora 支付Gas
- 嵌入式钱包: 优先USDC支付
- 外部钱包: 默认SOL，可选USDC

**交易:**
- 平台承担所有Gas
- 用户完全免费

### 2.11-2.12 钱包交互

无需存款/提现功能:
- 用户直接用自己钱包交互
- 拆分/合并直接操作用户代币账户
- 交易通过链下撮合实现

### 2.13 打赏功能

**打赏对象:**
- 市场创建者
- 评论用户

**效果:**
- 市场打赏: 提升首页排名
- 评论打赏: 提升评论排名

**打赏代币:** 指定Meme币 (待发布)

### 2.14 排行榜

**排行维度:**
- 盈利/亏损
- 交易量
- 创建市场数
- 终结市场数

**时间范围:**
- 全部
- 每日
- 每周
- 每月

### 2.15 市场分类

**默认分类:**
- 体育
- 政治
- 加密货币
- 娱乐
- 科技
- 其他

**管理员操作:**
- 添加新分类
- 删除分类
- 调整排序

### 2.16 首页与导航

**首页:**
- 按打赏金额排序
- 热门市场展示

**侧边栏:**
- 创建市场按钮
- 所有市场入口
- 个人仪表盘
- 设置

**所有市场页面:**
- 二级导航: 打赏最多 | 最新
- 分类筛选
- 搜索功能

### 2.17 市场收藏

- 每个市场卡片有收藏按钮
- 收藏的市场在个人仪表盘查看
- 收藏状态实时同步

---

## 市场生命周期

```
创建 (Created)
    │
    ▼
激活 (Active)
    │
    ├── 用户交易 ──────────────────────────────┐
    │       │                                  │
    │       ├── 买入触发VRF ─── 0.1%概率 ──── 随机终止 (Terminated)
    │       │                                  │
    │       └── 正常交易 ─────────────────────┘
    │
    ├── 7天无活动 ──────────────────────────── 不活跃终止 (Terminated)
    │
    └── 管理员结算 ─────────────────────────── 结算 (Settled)
                                                │
                                                ▼
                                          用户赎回仓位
                                                │
                                                ▼
                                            市场关闭
```

### 状态说明

| 状态 | 代码值 | 描述 |
|------|--------|------|
| Active | 0 | 市场活跃，可交易 |
| Settled | 1 | 管理员结算 |
| Paused | 2 | 暂停交易 |
| Terminated | 4 | 自动终止 |

### 终止价格确定

**随机终止:**
- 价格 = 触发终止交易的成交价

**不活跃终止:**
- 价格 = 最后一笔交易的价格
- 如无交易 = 0.50 (50%)

---

## 用户指南

### 新用户入门

1. **连接钱包**
   - 点击"连接钱包"
   - 选择Magic Link或外部钱包
   - 首次登录设置@用户名

2. **准备资金**
   - 确保钱包有USDC
   - 嵌入式钱包可通过交易所转入

3. **参与市场**
   - 浏览市场或搜索感兴趣的主题
   - 点击进入市场详情

4. **交易**
   - 拆分USDC获得YES/NO代币
   - 或直接在订单簿下单

### 交易策略

**拆分套利:**
- 当 YES + NO < 1 USDC 时
- 买入 YES 和 NO
- 合并获得 USDC

**做市赚取返佣:**
- 挂限价单提供流动性
- 获得20%手续费返佣
- 参与每日流动性奖励

### 风险提示

1. 市场可能随时随机终止
2. 最终结果基于最后交易价格
3. 请仅使用可承受损失的资金

---

## 管理员指南

### 管理员权限

| 操作 | 描述 | 命令/API |
|------|------|----------|
| 暂停市场 | 紧急暂停某个市场 | `POST /admin/pause/:marketId` |
| 恢复市场 | 恢复暂停的市场 | `POST /admin/resume/:marketId` |
| 结算市场 | 手动结算市场 | `POST /admin/settle/:marketId` |
| 更新费率 | 调整全局费率 | `POST /admin/fee-rates` |
| 更新终止概率 | 调整VRF终止概率 | `POST /admin/termination-probability` |
| 管理分类 | 添加/删除市场分类 | `POST /admin/categories` |

### 定时任务

| 任务 | 频率 | 描述 |
|------|------|------|
| check-inactive | 每小时 | 检查不活跃市场 |
| terminate-inactive | 每日 | 终止不活跃市场 |
| distribute-rewards | 每日UTC 0:00 | 分发做市商奖励 |
| sync-markets | 每5分钟 | 同步链上市场数据 |

### 紧急操作

**暂停所有交易:**
```bash
# 通过API
curl -X POST https://api.catallaxyz.com/admin/pause-all \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

**提取平台费用:**
```bash
yarn ts-node scripts/withdraw-platform-fees.ts
```

---

## 费用结构

### 用户费用

| 操作 | 费用 |
|------|------|
| 创建市场 | 10 USDC |
| 限价单 | 0% |
| 市价单 | 0.2% - 3.2% |
| 拆分/合并 | Gas (Kora) |
| 赎回 | Gas (Kora) |

### 平台收入

| 来源 | 金额 |
|------|------|
| 市场创建费 | 10 USDC/市场 |
| 交易手续费(75%) | 变动 |
| VRF费用溢出 | 少量SOL |

---

## 安全机制

### 签名验证

所有链上交易使用Ed25519签名验证:
- 结算签名者密钥签名成交
- 合约验证签名有效性
- 防止未授权交易

### 溢出保护

所有算术运算使用checked math:
```rust
let result = a.checked_add(b).ok_or(Error::Overflow)?;
```

### 访问控制

- 管理员函数限制authority钱包
- Keeper函数限制keeper钱包
- 用户函数验证用户签名

### 暂停机制

紧急情况下可暂停市场:
- 阻止新交易
- 允许用户合并退出
- 保护用户资金

### 不变量检查

```rust
// 仓位抵押 = YES供应 = NO供应
assert!(market.total_position_collateral == market.total_yes_supply);
assert!(market.total_yes_supply == market.total_no_supply);
```

---

## 附录

### API 端点列表

**Data API (端口 3001):**

| 端点 | 方法 | 描述 |
|------|------|------|
| `/markets` | GET | 获取市场列表 |
| `/markets/:id` | GET | 获取市场详情 |
| `/markets` | POST | 创建市场 |
| `/trades` | GET | 获取交易记录 |
| `/users/me` | GET | 获取当前用户 |
| `/users/me` | PATCH | 更新用户信息 |
| `/users/auth` | POST | 钱包签名认证 |
| `/users/register-username` | POST | 注册用户名 |
| `/notifications` | GET | 获取通知 |
| `/favorites` | POST | 收藏市场 |
| `/leaderboard` | GET | 获取排行榜 |

**CLOB API (端口 3002):**

| 端点 | 方法 | 认证 | 描述 |
|------|------|------|------|
| `/api-key` | POST | L1 | 创建/获取 API Key |
| `/api-key` | DELETE | L2 | 撤销 API Key |
| `/api-key/rotate` | POST | L2 | 轮换 API Secret |
| `/verify` | GET | L2 | 验证当前会话 |
| `/orders` | POST | L2 | 下单 |
| `/orders` | GET | L2 | 获取订单列表 |
| `/orders/:id` | GET | L2 | 获取订单状态 |
| `/orders/:id` | DELETE | L2 | 取消订单 |
| `/orders/cancel-all` | POST | L2 | 取消所有订单 |
| `/orderbook/:marketId` | GET | 无 | 获取订单簿 |
| `/balances` | GET | L2 | 获取余额 |

### 常见问题

**Q: 市场什么时候会终止?**
A: 两种情况: 1) 买入交易后0.1%概率随机终止; 2) 7天无交易自动终止

**Q: 终止后如何赎回?**
A: 在市场详情页点击"赎回"，按最终价格兑换USDC

**Q: 手续费返佣怎么获得?**
A: 挂限价单成交后自动获得20%手续费返佣

**Q: 如何成为做市商?**
A: 在市场中挂限价单提供流动性，即可参与每日奖励分配

### 合约指令列表

**基础操作:**

| 指令 | 描述 |
|------|------|
| `initialize` | 初始化全局程序状态 |
| `create_market` | 创建新预测市场 |
| `settle_market` | 结算市场 |
| `split_position_single` | 拆分 USDC → YES + NO |
| `merge_position_single` | 合并 YES + NO → USDC |
| `redeem_single_outcome` | 赎回结算后的仓位 |

**CLOB 交易:**

| 指令 | 描述 |
|------|------|
| `deposit_usdc` | 存入 USDC 到市场金库 |
| `withdraw_usdc` | 从市场金库提取 USDC |
| `settle_trade` | 结算单笔交易 |

**Exchange 风格 (Polymarket 兼容):**

| 指令 | 描述 |
|------|------|
| `fill_order` | 执行单个签名订单 |
| `match_orders` | 原子匹配多个订单 |
| `cancel_order` | 取消订单 (链上) |
| `increment_nonce` | 批量取消低 nonce 订单 |

**管理指令:**

| 指令 | 描述 |
|------|------|
| `pause_market` | 暂停市场 |
| `resume_market` | 恢复市场 |
| `pause_trading` | 全局暂停交易 |
| `unpause_trading` | 恢复全局交易 |
| `add_operator` | 添加操作员 |
| `remove_operator` | 移除操作员 |
| `set_keeper` | 设置 Keeper 钱包 |
| `update_fee_rates` | 更新费率 |
| `update_market_params` | 更新市场参数 |

---

**文档版本:** v1.1.0  
**最后更新:** 2026年1月31日
