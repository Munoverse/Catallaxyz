# Catallaxyz 代码审计报告（前后端/合约/数据库）

生成时间：2026-01-27

## 范围
- 前端：`app/`（页面、组件）
- 后端：`backend/`（脚本、日志）
- 合约：`programs/catallaxyz/`（指令、状态、常量）
- 共享：`shared/`（常量、类型）
- 数据存储：`backend/db/termination_log.json`

## 主要发现（按严重度）

### 高
1) **钱包/鉴权为硬编码占位**
- 现状：多处 `authenticated=false`，钱包为 `[]`，导致无法登录/创建市场。
- 影响：核心功能不可用。

2) **关键页面缺失**
- 现状：`/markets`、`/portfolio`、`/market/[id]` 被导航使用但不存在页面。
- 影响：导航与创建后的跳转失败。

### 中
3) **前端表单与合约参数不一致**
- 现状：前端采集 `description/yesDescription/noDescription`，合约仅接收 `question + market_id`。
- 影响：用户输入被忽略，产品行为不一致。

4) **后端日志存储双轨**
- 现状：SQLite schema 存在，但实际写入 JSON 日志。
- 影响：维护成本高，数据来源不统一。

5) **重复 UI 逻辑**
- 现状：登录提示弹窗在多处复制。
- 影响：维护与一致性成本增加。

### 低
6) **常量重复定义（Rust/TS）**
- 现状：状态/费用等常量在 Rust 与 TS 中重复维护。
- 影响：存在漂移风险。

7) ~~**历史指令疑似遗留**~~
- ✅ **已修复 (2026-01-31)**：移除了废弃的 `init_treasury` 指令和相关的 VRF treasury 代码
- 移除内容：`init_treasury.rs`、`TREASURY_SEED`、`treasury_bump`、`total_fees_collected`、`settle_trade_nonce`
- 原因：Switchboard On-Demand 模式不需要预付 VRF 费用，VRF treasury 已无用

8) **健壮性问题**
- 现状：`switchboard_lite` 中存在 `expect`。
- 影响：低概率 panic 风险。

## 一致性结论
- **前后端与合约**：前端只实现创建市场，未覆盖交易/结算/赎回等核心合约功能。
- **后端与数据库**：日志实际写入 JSON，SQLite schema 仅“可选”。
- **常量**：目前一致，但重复来源易漂移。
- **提示语言**：未发现非英文提示。

## 修复与优化建议清单
1) **接入真实钱包与鉴权**（优先）
2) **补齐缺失页面路由**（优先）
3) **对齐前端表单与合约参数**（优先）
4) **抽象登录弹窗组件**（中）
5) **统一常量来源**（中）
6) **统一日志存储路径（JSON or SQLite）**（中）
7) **清理/标记遗留指令**（低）
8) **输入约束与错误处理增强**（低）

## 本次开始修复的范围
- 对齐前端表单与合约参数（移除未用字段）
- 引入钱包与 Magic 社交登录入口（按需求开始接入）
